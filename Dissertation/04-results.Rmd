---
output:
  #bookdown::html_document2: default
  #bookdown::word_document2: default
  bookdown::pdf_document2:
    dev: png
    template: templates/brief_template.tex
    citation_package: biblatex
bib-humanities: true
documentclass: book
bibliography: references.bib
---

# Results {#results} 

```{r load-packages, echo = FALSE, message = FALSE,error=FALSE,warning=FALSE}

# Load libraries
library(sf)
library(scales)
library(tidyverse)
library(tmap)
library("rnaturalearth")
library("rnaturalearthdata")
library(ncdf4)
library(pbapply)
#devtools::install_github("ropensci/rnaturalearthhires")
library("rnaturalearthhires")
library(kableExtra)
library(ggpubr)
# Load scripts
source('../Methods/define_peaks_ranges.R')
source('../Methods/extract_age.R')
source('../Methods/extract_rsl.R')
source('../Methods/extract_GIA.R')
source('../Methods/join_age_rsl.R')
source('../Methods/compare_sli_gia.R')
source('../Methods/compare_regions.R')
```

```{r load-datasets, echo = FALSE, message = FALSE,error=FALSE,warning=FALSE}
# Seed
set.seed(1)

## Loading general Data sets

# Border lines
world = rnaturalearth::ne_countries(scale = "large", returnclass = "sf")

# WALIS (Sea level indicators database)
# Select only 'Equal to' Indicators 
walis<-read.csv("../Data/walis.csv")
walis <- walis[walis$Timing.constraint=="Equal to",]
walis<- st_as_sf(walis,coords=c("Longitude","Latitude"),crs=st_crs(4326)) 

# GIA Models 
nc_data <- nc_open('../Data/GIA_Austermann_2019.nc')

## Sea level stack
sl_stack <- read.csv("../Data/sea_level",sep = "")
```

## South American Atlantic coast (5-55ยบ S)

### Area of study

The analysis of the South American Atlantic coast (See Figure \@ref(fig:area-of-study-south-america)) comprises four different regions selected to compare the difference between sea-level indicators and GIA models using the proposed methodology in a passive margin. These areas correspond to the North East (BR[NE]) and South of Brazil (BR[S]), the Northern Argentinian and Uruguayan coast (ARG[NE]-UY), and the southeast of Argentina (ARG[SE]). There are a total number of 250 Sea level index points (type of data point) in the whole area of study. The criteria used to define the areas correspond to proximity (latitudinal distance) between sea-level indicators. Table \@ref(tab:sa-atlantic-num-slip) shows the total number of SLIP and the origin of their age calculation (i.e., radiometric dating or MIS assignment).

```{r area-of-study-south-america,cache=TRUE, fig.cap= 'South American Atlantic coast. Regions and sea-level indicators location.',fig.scap= 'South American Atlantic coast.', echo = FALSE, message = FALSE,error=FALSE,warning=FALSE,results='hide', out.width = "50%",dpi=300,fig.align = "center"}

# Regions to compare
region_sa_atlantic <- st_read('../Data/CaseStudy_1.kml')
region_sa_atlantic$Description <- factor(region_sa_atlantic$Name,levels=c('BR[NE]','BR[S]','ARG[NE]-UY','ARG[SE]'))

# Select WALIS (Indicators) from area of study
walis$in_area<-apply(st_intersects(walis, region_sa_atlantic,sparse = FALSE),1,any)
sa_atlantic_sli<-walis[walis$in_area==TRUE,]

# Select coastlines and borders from area of study
south_america_borders = world[world$subregion=='South America' , ]

# Plot of area of study

tm_shape(south_america_borders,bbox=st_bbox(region_sa_atlantic))+ tm_graticules(alpha=0.5) +
  tm_fill() + tm_borders() + tm_text("name_long",size= 0.5,legend.size.show=FALSE) +
  tm_shape(sa_atlantic_sli) +
  tm_dots(col = 'Type.of.datapoint', size=0.1,shape=10,palette='viridis',title="Datapoint type") +
  tm_shape(region_sa_atlantic)+ tm_polygons(col='Description',alpha=0.2,palette = c("#88CCEE", "#CC6677", "#DDCC77", "#117733"), title='Regions')+tm_legend()+
  tm_layout(legend.title.size = 0.7, legend.text.size = 0.5, legend.width = 0.4, legend.bg.color = "white",legend.frame = "black", legend.position =c('right','bottom')) +
  tm_compass(type = '8star',position = c("left", "top"), size = 2)

```


```{r sa-atlantic-num-slip, echo = FALSE, message = FALSE, warning=FALSE}


sa_atlantic_sli$subregion <- factor(region_sa_atlantic$Name[unlist(st_intersects(sa_atlantic_sli,region_sa_atlantic))])

sa_atl_SLIP <- sa_atlantic_sli[sa_atlantic_sli$Type.of.datapoint=='Sea Level Indicator',]

table <- sa_atl_SLIP %>% group_by(subregion) %>% summarize(num_SLIP=n(),radiometric=sum(Age.calculation.from=='Radiometric dating'),uniform=sum(Age.calculation.from!='Radiometric dating')) %>% st_drop_geometry()

table$subregion <- factor(table$subregion,levels=c('BR[NE]','BR[S]','ARG[NE]-UY','ARG[SE]'))

table%>%arrange(subregion)%>% knitr::kable(caption = "South America Atlantic coast - Number of SLIP by region",
                           col.names = c('Region name','Number of Sea level Indicators','Radiometric dating','MIS assignment (Uniform)'), escape = FALSE, booktabs=T, digits = 1) %>%add_header_above(c(" "=2, "Origin age calculation" = 2)) %>% kable_styling(font_size = 10,latex_options = c("striped", "scale_down"))

```


```{r south-america-atlantic-peaks-processing, eval=TRUE, echo=FALSE, warnings=FALSE, error=FALSE, results='hide'}

#Processing
n_sample <- 10000
file_sa_atlantic_peak <- file.path('processing','sea_level_indicators',paste0('sa_atlantic_peaks_',n_sample,'.RData'))

if (file.exists(file_sa_atlantic_peak)) {
  load(file_sa_atlantic_peak)
} else {
  start.time <- Sys.time()
  # Sample SLI (RSL+Age) from total area
  cloud_sa_atlantic <- extract_slip_region(sa_atlantic_sli, sl_stack = sl_stack, n_samplig=n_sample)
  # Remove values over 200 ka
  cloud_sa_atl_200 <- cloud_sa_atlantic[cloud_sa_atlantic$AGE<200,]
  # Classify by regions
  cloud_sa_atl_200 <- clasify_by_regions(cloud_sa_atl_200,region_sa_atlantic,sa_atlantic_sli)
  # Extract Residual values by sub regions
  res_sa_atl_200 <- residuals_by_regions(region_sa_atlantic,cloud_sa_atl_200,sa_atlantic_sli,per_sampling=0.3)
  # Extract residuals by regions in high density age ranges
  res_hdar_sa_atl_200 <- residual_high_density_age_range(res_sa_atl_200)
  dir.create('processing')
  dir.create(file.path('processing','sea_level_indicators'))
  save(cloud_sa_atlantic, cloud_sa_atl_200,res_sa_atl_200,res_hdar_sa_atl_200, file = file_sa_atlantic_peak)

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken
}
```

```{r south-america-atlantic-no-peaks-processing, eval=TRUE, echo=FALSE, warnings=FALSE, error=FALSE, results='hide'}

#Processing

n_sample <- 10000
file_sa_atlantic_no_peaks <- file.path('processing','sea_level_indicators',paste0('sa_atlantic_no_peaks_',n_sample,'.RData'))

if (file.exists(file_sa_atlantic_no_peaks)) {
  load(file_sa_atlantic_no_peaks)
} else {
  start.time <- Sys.time()
  # Sample SLI (RSL+Age) from total area
  cloud_sa_atlantic_np <- extract_slip_region(sa_atlantic_sli, n_samplig=n_sample)
  # Remove values over 200 ka
  cloud_sa_atl_200_np <- cloud_sa_atlantic_np[cloud_sa_atlantic_np$AGE<200,]
  # Classify by regions
  cloud_sa_atl_200_np <- clasify_by_regions(cloud_sa_atl_200_np,region_sa_atlantic,sa_atlantic_sli)
  # Extract Residual values by sub regions
  res_sa_atl_200_np <- residuals_by_regions(region_sa_atlantic,cloud_sa_atl_200_np,sa_atlantic_sli,per_sampling=0.3)
  # Extract residuals by regions in high density age ranges
  res_hdar_sa_atl_200_np <- residual_high_density_age_range(res_sa_atl_200_np)
  dir.create('processing')
  dir.create(file.path('processing','sea_level_indicators'))
  save(cloud_sa_atlantic_np, cloud_sa_atl_200_np,res_sa_atl_200_np,res_hdar_sa_atl_200_np, file = file_sa_atlantic_no_peaks)

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken
}
```


```{r south-america-atlantic-GIA-values, eval=TRUE, echo=FALSE, warnings=FALSE, error=FALSE, results='hide',out.width = "80%",fig.align = "center",cache=TRUE}

#Processing

gia_atlantic_file <- file.path('processing','GIA_values','GIA_values_atlantic.RData')

if (file.exists(gia_atlantic_file)) {
  print('Loading results from pre-processing')
  load(gia_atlantic_file)
} else {
  #GIA Values per area
  gia_values <- extract_gia(nc_data,cloud_sa_atl_200,sa_atlantic_sli)
  gia_values_atlantic <- bind_rows(gia_values)
  dir.create('processing')
  dir.create(file.path('processing','GIA_values'))
  save(gia_values_atlantic, file = gia_atlantic_file)
}

```

### SLIP Point cloud and GIA model values

Before the comparison of SLIP and GIA models, the individual elements were extracted for each region.  Figure \@ref(fig:south-america-atlantic-gia-plot) shows SLIP after extraction (sampling) as clouds of points grouped by area (horizontal) from north to south and type of sampling ('No peak sampling' and 'Peak sampling'). Differences between the sampling techniques are evident in the Brazilian (South) region. In this area, the SLIPs point cloud locates around particular age ranges. This effect of the sampling method is also visible in the other areas with different intensities. The average value (lines) and standard deviation (shaded area) of each of the 216 GIA model configurations by region are included in the graph (lines). For the four areas, the models show similar patterns during the last 200 ka. For example, the models exhibit relatively high variation between 200 and 130 ka compared to the 130 to 0 ka period. As the main difference, the areas located in Argentina and Uruguay (ARG[NE]-UY - ARG[SE]) have lower relative sea-level values between 160 and 130 ka than the Brazilian areas (BR[NE] and BR[S]).

```{r south-america-atlantic-gia-plot, fig.cap= 'South American Atlantic coast SLIP and GIA. Lines correspond to GIA models and points (Point cloud) to sea-level indicators resulting from SLIP sampling.',fig.scap= 'South American Atlantic coast - GIA models and SLIP point cloud', echo=FALSE, warnings=FALSE, message= FALSE, results='hide', dpi=300, cache=TRUE, out.width = '90%',fig.align = 'center',cache=TRUE}

# Adjust Dataframe
names_cloud <- c("WALIS_ID","RSL","AGE","region")
regions_names <- c('BR[NE]','BR[S]','ARG[NE]-UY','ARG[SE]')
names(cloud_sa_atl_200) <- names_cloud
names(cloud_sa_atl_200_np) <- names_cloud

# Organize 
cloud_sa_atl_200$type <- 'peak_sampling'
cloud_sa_atl_200_np$type <- 'no_peak'

# Combine different sampling methods
cloud_combined_sa_atl_200 <- bind_rows(cloud_sa_atl_200,cloud_sa_atl_200_np)
cloud_combined_sa_atl_200$region <- factor(cloud_combined_sa_atl_200$region,levels=regions_names)

gia_values_atlantic$region <- factor(gia_values_atlantic$region,levels=regions_names)

# Adjust group colors to match map
group.colors.atlantic <- c('BR[NE]' ='#88CCEE', 'BR[S]' = '#CC6677', 'ARG[NE]-UY' = "#DDCC77", 'ARG[SE]' = "#117733")

# Plot results
ggplot()+geom_ribbon(data=gia_values_atlantic,aes(x=time, y=mean, ymin=mean-sd,ymax=mean+sd,group=code,color=region)
                     ,alpha=0.01)+
  geom_point(data=sample_n(cloud_combined_sa_atl_200,20000),
             aes(x=AGE,y=RSL,group=region,color=region),
             alpha=0.01,shape = 21, size = 1, stroke=1)+
  facet_grid(region~type)+
  scale_color_manual(values=group.colors.atlantic)+xlim(200,0)+theme_bw()+theme(legend.position='none')+xlab('Age (Ka)')+ylab('Relative sea level (m)')+
  theme(panel.spacing = unit(.03, "lines"))

```

### Residual values

Comparison between SLIP (Point cloud) and GIA models resulted in residual values for these regions. Figure \@ref(fig:sa-atlantic-residual-plot) shows the fitted curves of residual values in high-density temporal ranges (i.e., more than 15% of highest age density) by area and sampling method. As the main difference between the sampling methods, residuals from peak sampling for uniform age distributions result in temporal ranges where no calculation of residual value is possible. However, for age ranges where both techniques have information, the residual levels and tendencies are similar. On the Brazilian northeast coast (BR[NE]), both sampling methods result in a rapid increase of residual values from 125 to 110 ka. For Brazil (South) and Argentina (North)/Uruguay areas, residual values around 125 ka are lower (around 0-15m) than the levels at 100 and 80 ka (25-30m). The southeast Argentinian area is the only area with residual values (high density) before 125 ka. This area shows an initial residual increase (up to 150 m around 160 to 150 ka) and a posterior decrease to 0 m (around 125 ka). Similarly, this area is the only one that shows information (peak sampling) for the period around 50 ka with high residual levels between 60 and 90 m. 

```{r sa-atlantic-residual-plot, eval=TRUE, echo=FALSE, warnings=FALSE, message= FALSE, results='hide',dpi=300,cache=TRUE,out.width = "100%",fig.align = "center", fig.cap= 'South American Atlantic coast. Residual values by region and sampling method. Solid line correspond to fitted line. Bins represent number of points (point cloud) by age and residual value. ',fig.scap= 'South American Atlantic coast - Residual values'}

# Add type of sampling
res_hdar_sa_atl_200$type <- 'peak_sampling'
res_hdar_sa_atl_200_np$type <- 'no_peak'

# Merge into single data frame
res_combined_sa_atl_200 <- bind_rows(res_hdar_sa_atl_200,res_hdar_sa_atl_200_np)
res_combined_sa_atl_200$region <- factor(res_combined_sa_atl_200$region,levels=regions_names)

# Plot results
ggplot(res_combined_sa_atl_200,aes(age,residual,region,group=code,color=region))+geom_bin2d()+scale_fill_viridis_c(trans='log10',option='magma',alpha=0.5)+geom_smooth(aes(group=code,color=region),level=0.95) + xlim(200,0)+scale_color_manual(values=group.colors.atlantic)+facet_grid(region~type)+theme_bw()+theme(panel.spacing = unit(.03, "lines"))+labs(colour='Region')+xlab('Age (ka)')+ylab('Residual (m)')

```

### Evaluation

Residual values partially result from the random selection of GIA models that have a particular configuration of parameters. For that reason, the comparison of residual values by their grouping parameters (e.g., lower mantle viscosity) could provide indications of residual values differences due to GIA models parameters. Figure \@ref(fig:sa-atlantic-mean-plot) shows the mean residual values by model parameters (A to E) and by sampling method (F). Comparison between different grouping parameters (A to E) using the same sampling methods shows a similar distribution of mean values. However, the residual values form three distinct groups that do not correspond to differences in the model parameters. As a general observation, residual values tend to be higher for residuals using 'no-peak' sampling for all the model parameters (See Figure \@ref(fig:sa-atlantic-mean-plot).F). That is confirmed by a Kruskal test with a P-value lower than 0.05 testing the $H_{0}$ hypothesis that the mean values are equal.

```{r sa-atlantic-mean-plot, eval=TRUE, echo=FALSE, warnings=FALSE, message= FALSE, results='hide',dpi=300,cache=TRUE, out.width='100%',fig.height = 8,fig.width=9,fig.align = "center",fig.cap= 'South American Atlantic coast mean residual values by model parameters and sampling method.',fig.scap= 'South American Atlantic coast - Mean residual values by grouping parameters'}

mean_models <- res_combined_sa_atl_200%>%group_by(type,region,propagation,ice,lm,um,lt)%>%summarise(mean = mean(residual),sd = std(residual),n =n())

mean_models$region <- factor(mean_models$region,levels=regions_names)

fig_1 <- ggplot(mean_models, aes(factor(propagation),mean,fill=factor(propagation)))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour = factor(propagation)),alpha=0.5,width = 0.2)+labs(fill = "Propagation",colour='Propagation')+xlab("Propagation")+ylab("Mean (Residual) ")+facet_wrap(~type,ncol=2)+theme_bw()+theme(legend.position = 'none')


fig_2 <-ggplot(mean_models, aes(factor(ice),mean,fill=factor(ice)))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour = factor(ice)),alpha=0.5,width = 0.2)+labs(fill = "Ice\nmodel",colour='Ice\nmodel')+xlab("Ice model")+ylab("Mean (Residual)")+facet_wrap(~type,ncol=2)+theme_bw()+theme(legend.position = 'none')


fig_3 <-ggplot(mean_models, aes(factor(lm),mean,fill=factor(lm)))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour = factor(lm)),alpha=0.5,width = 0.2)+labs(fill = "Lower\nmantle\nviscosity",colour='Lower\nmantle\nviscosity')+xlab("Lower mantle viscosity")+ylab("Mean (Residual) ")+facet_wrap(~type,ncol=2)+theme_bw()+theme(legend.position = 'none')


fig_4 <-ggplot(mean_models, aes(factor(um),mean,fill=factor(um)))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour = factor(um)),alpha=0.5,width = 0.2)+labs(fill = "Upper\nmantle\nviscosity",colour='Upper\nmantle\nviscosity')+xlab("Upper mantle viscosity")+ylab("Mean (Residual) ")+facet_wrap(~type,ncol=2)+theme_bw()+theme(legend.position = 'none')


fig_5 <-ggplot(mean_models, aes(factor(lt),mean,fill=factor(lt)))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour = factor(lt)),alpha=0.5,width = 0.2)+labs(fill = "Lithospheric\nthickness",colour='Lithospheric\nthickness')+xlab("Lithospheric thickness")+ylab("Mean (Residual) ")+facet_wrap(~type,ncol=2)+theme_bw()+theme(legend.position = 'none')


fig_6 <- ggplot(mean_models, aes(factor(type),mean,fill=factor(type)))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour = factor(type)),alpha=0.5,width = 0.2)+labs(fill = "Sampling\n type",colour='Sampling\n type')+xlab("Sampling type")+ylab("Mean (Residual) ")+theme_bw()+theme(legend.position = 'none')

figure <- ggarrange(fig_1, fig_2, fig_3,fig_4,fig_5,fig_6,
                    labels = c("A", "B", "C","D","E","F"),
                    ncol = 2, nrow = 3)
figure

```
Additional Kruskal tests were applied to identify if differences in mean residual ($\mu_{\varepsilon}$) values result from different GIA model parameters (See Table \@ref(tab:sa-atlantic-kruskal)). The residual values groups also include their geographic area and specific model (combination of all parameters). The $H_{0}$ hypothesis for all tests is that the mean value of all parameters is the same. For example, for the Propagation parameter, $H_{0}$ is that $\mu_{\varepsilon(Wael-S)}$ is equal to $\mu_{\varepsilon(Wael-P)}$. $H_{1}$ for all cases is that mean values are different. Table \@ref(tab:sa-atlantic-kruskal) shows that for the 'no peak' sampling, almost all model parameters (except Propagation), region, and specific model test, result in a P-value lower than 0.05 rejecting $H_{0}$ (P-values lower than 0.05 in **bold**). Similarly, for the cases using the peak sampling method, $H_{0}$ is rejected for most model parameters (except Upper mantle viscosity), region, and specific model. 

```{r sa-atlantic-kruskal, echo = FALSE, message = FALSE, warning=FALSE, cache=TRUE}

# Add model parameter to residuals

# Peak sampling
res_hdar_sa_atl_200$model <- as.factor(paste(res_hdar_sa_atl_200$propagation,
                                              res_hdar_sa_atl_200$ice,
                                              res_hdar_sa_atl_200$lm,
                                              res_hdar_sa_atl_200$um,
                                              res_hdar_sa_atl_200$lt,
                                              sep='-')
                                       )
# Normal sampling (np)

res_hdar_sa_atl_200_np$model <- as.factor(paste(res_hdar_sa_atl_200_np$propagation,
                                              res_hdar_sa_atl_200_np$ice,
                                              res_hdar_sa_atl_200_np$lm,
                                              res_hdar_sa_atl_200_np$um,
                                              res_hdar_sa_atl_200_np$lt,
                                              sep='-')
                                       )

file_sa_atlantic_kruskal<- file.path('processing','kruskal_test','sa_atlantic_kruskal.RData')

if (file.exists(file_sa_atlantic_kruskal)){
  load(file_sa_atlantic_kruskal)
}else{
  
  # Kruskal test for peak sampling residuals
  kt_sa_atl <- lapply(colnames(res_hdar_sa_atl_200)[c(3,5,6,7,8,9,11)], function(x) kruskal.test(res_hdar_sa_atl_200$residual ~ as.factor(unlist(res_hdar_sa_atl_200[x])), data = res_hdar_sa_atl_200))
  
  # Kruskal test for residuals (no peak sampling)
  
  kt_sa_atl_np <- lapply(colnames(res_hdar_sa_atl_200_np)[c(3,5,6,7,8,9,11)], function(x) kruskal.test(res_hdar_sa_atl_200_np$residual ~ as.factor(unlist(res_hdar_sa_atl_200_np[x])), data = res_hdar_sa_atl_200_np))
  
  dir.create(file.path('processing','kruskal_test'))
  save(kt_sa_atl,kt_sa_atl_np, file = file_sa_atlantic_kruskal)
}

  param_names <- c('Region','Propagation','Ice','Lower mantle viscosity','Upper mantle viscosity','Lithospheric thickness', 'Model')
sa_atl_kt <- data.frame(parameter=param_names,df = unlist(lapply(kt_sa_atl_np, '[[', 2)),chi_np=unlist(lapply(kt_sa_atl_np, '[[', 1)),p_value_np=unlist(lapply(kt_sa_atl_np, '[[', 3)),chi_ps=unlist(lapply(kt_sa_atl, '[[', 1)),p_value_ps=unlist(lapply(kt_sa_atl, '[[', 3)))

#Highlight significant P-value

pv_np <- sa_atl_kt$p_value_np<0.05
h_pv_np <- pv_np
h_pv_np<- replace(h_pv_np,pv_np,'#e6ffe6')
h_pv_np <- replace(h_pv_np,!pv_np,'white')

pv_ps<- sa_atl_kt$p_value_ps<0.05
h_pv_ps <- pv_ps
h_pv_ps <- replace(h_pv_ps,h_pv_ps,'#e6ffe6')
h_pv_ps <- replace(h_pv_ps,!pv_ps,'white')

sa_atl_kt$p_value_np <- scientific(sa_atl_kt$p_value_np,digits = 3) 
sa_atl_kt$p_value_ps <- scientific(sa_atl_kt$p_value_ps,digits = 3) 

sa_atl_kt%>% knitr::kable(caption = "South America Atlantic coast - Kruskal test",
                           col.names = c('Parameter','Degrees of freedom','$\\tilde{\\chi}^2$','P-value','$\\tilde{\\chi}^2$','P-value'), escape = FALSE, booktabs=T, digits = 1) %>% column_spec(4, bold = pv_np)%>%column_spec(6, bold = pv_ps)%>%add_header_above(c(" "=2, "No peak sampling" = 2, "Peak sampling" = 2)) %>% kable_styling(font_size = 10,latex_options = c("striped", "scale_down"))

```
To assess the indications from the Kruskal test that mean values by parameters, region, and specific models are not the same, a Pair-Wise Wilcox test was performed to determine the parameters configuration with different mean residual values ($\mu_{\varepsilon}$). Table \@ref(tab:sa-atlantic-wilcox-table) shows total possible combinations (Pairs) for each grouping parameter. For example, as Propagation only have two parameters (i.e., $Wael_S$ and $Wael_T$), there is only one possible pair. Table \@ref(tab:sa-atlantic-wilcox-table) shows how many of those pairs have statistically significant differences (P-value < 0.05) for their mean values according to the Wilcox test. As the main result, all pairs of regions have statistically significant differences for both sampling techniques. For the 'No-peaks' sampling, the lower-mantle viscosity, Upper-mantle viscosity, and Lithospheric thickness grouping parameters also have residual values that are consistently different between the different parameter values. However, different results are obtained for the 'Peak sampling' method, where the Propagation and Lithospheric thickness parameters have consistent differences. Similarly, from the 23.220 possible pairs of models, only 7 and 1 have statistically significant differences in their mean values for the no-peak and peak sampling methods.

```{r sa-atlantic-wilcox-processing, eval=TRUE, echo=FALSE, warnings=FALSE, message= FALSE, cache=TRUE}

file_sa_atlantic_wilcox<- file.path('processing','wilcox_test','sa_atlantic_wilcox.RData')

if (file.exists(file_sa_atlantic_wilcox)){
  load(file_sa_atlantic_wilcox)
}else{
  wilcox_atl_peak <- lapply(colnames(res_hdar_sa_atl_200)[c(3,5,6,7,8,9,11)], function(x) pairwise.wilcox.test(res_hdar_sa_atl_200$residual, as.factor(unlist(res_hdar_sa_atl_200[x])),p.adjust.method = "bonferroni"))
  
  wilcox_atl_np <- lapply(colnames(res_hdar_sa_atl_200_np)[c(3,5,6,7,8,9,11)], function(x) pairwise.wilcox.test(res_hdar_sa_atl_200_np$residual, as.factor(unlist(res_hdar_sa_atl_200_np[x])),p.adjust.method = "bonferroni"))
  
  dir.create(file.path('processing','wilcox_test'))
  save(wilcox_atl_peak,wilcox_atl_np, file = file_sa_atlantic_wilcox)
}

```

```{r sa-atlantic-wilcox-table, echo = FALSE, message = FALSE, warning=FALSE}


sa_atl_pairwise_wilcox <- data.frame(parameter = param_names,
                                     pairs = unlist(lapply(c(3,5,6,7,8,9,11),function(x) choose(nrow(unique(res_hdar_sa_atl_200[x])),2))),
                                     sig.dif.np = unlist(lapply(1:7, function(x) sum(wilcox_atl_peak[[x]][['p.value']]<0.05,na.rm=TRUE))),
                                     sig.dif.peaks = unlist(lapply(1:7, function(x) sum(wilcox_atl_np[[x]][['p.value']]<0.05,na.rm=TRUE)))
                                     )

sa_atl_pairwise_wilcox%>% knitr::kable(caption = "South America Atlantic coast - Pairwise Wilcox test",
                           col.names = c('Grouping parameter','Number of pairs','Significant different pairs','Significant different pairs'), escape = FALSE, booktabs=T, digits = 1) %>%add_header_above(c(" "=2, "Normal sampling" = 1, "Peak sampling" = 1)) %>% kable_styling(font_size = 10,latex_options = c("striped", "scale_down"))


```


```{r south-america-atlantic-mean-region, eval=TRUE, echo=FALSE, warnings=FALSE, message= FALSE, results='hide',dpi=300,cache=TRUE,out.width = "90%",fig.height = 8,fig.width=10, fig.align = "center", fig.cap= 'South American Atlantic coast mean residual values by region.',fig.scap= 'South American Atlantic coast - Mean residual values by region'}

mean_models <- res_combined_sa_atl_200%>%group_by(region,propagation,ice,lm,um,lt,type)%>%summarise(mean = mean(residual),sd = std(residual),n =n())

fig_region <- ggplot(mean_models, aes(factor(region),mean,colour=region))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour=factor(region)),alpha=0.1,width = 0.2)+scale_color_manual(values=group.colors.atlantic)+facet_wrap(vars(type),ncol=2)+labs(colour='Region')+xlab("Region")+ylab("Mean (Residual)")+theme_bw()

fig_region

```

Figure \@ref(fig:south-america-atlantic-mean-region) shows the residual mean values grouped by region. As suggested by the Kruskal tests, residual mean values between different sampling techniques are different, showing lower values for the 'peak sampling' method if grouped by regions. Both sampling techniques show similar trends concerning the relative order between sub-regions. From north to south, the Brazilian northeast coast (BR[NE]) shows the smallest residual values, followed by the Brazilian south coast (BR[S]), the Argentinian (North-East)/Uruguay (ARG[NE]-UY), and the Argentinian southeast (ARG[SE]) with higher mean residual values.

## South American Pacific coast (1ยบN-40ยบS)

### Area of study

The proposed comparison methodology was tested in an active tectonic margin along four different regions in the pacific coast of South American (See Figure \@ref(fig:area-of-study-south-america-pacific)). These areas correspond to the Ecuadorian and northern Peruvian coast (Ecuador-Peru[n]), the central and southern Peruvian coast (Peru[C-S]), the northern (Chile[N]), and central (Chile[C]) Chilean coast. There are 2150 sea-level index points (type of data point) for the whole area of study. More than 80% of SLIP in this region have as their age calculation origin a designated MIS uniform temporal constraint (See Table \@ref(tab:sa-pacific-num-slip)). The selected areas division corresponds to the four sectors proposed by @Freisleben2021 based on the main geomorphic characteristics of the Pacific coast of South America.

```{r area-of-study-south-america-pacific, fig.cap= 'South American Pacific coast.',fig.scap='South American Pacific coast - Regions and sea-level indicators location.', echo = FALSE, message =FALSE,error=FALSE,warning=FALSE,results='hide', out.width = "40%",dpi=300,fig.align = "center"}

set.seed(2)
# Regions to compare
regions_sa_pacific <- st_read('../Data/CaseStudy_2.kml')
regions_sa_pacific$Description <- factor(regions_sa_pacific$Name,levels=c('Ecuador-Peru[N]','Peru[C-S]','Chile[N]','Chile[C]'))

# Select WALIS (Indicators) from area of study
walis$in_area<-apply(st_intersects(walis, regions_sa_pacific,sparse = FALSE),1,any)
sa_pacific_sli<-walis[walis$in_area==TRUE,]

# Select coastlines and borders from area of study
south_america_borders = world[world$subregion=='South America' , ]

# Plot of area of study

tm_shape(south_america_borders,bbox=st_bbox(regions_sa_pacific ))+ tm_graticules(alpha=0.5) +
  tm_fill() + tm_borders() + tm_text("name_long",size= 0.5,legend.size.show=FALSE) +
  tm_shape(sa_pacific_sli) +
  tm_dots(col = 'Type.of.datapoint', size=0.1,shape=10,palette='viridis',title="Datapoint type") +
  tm_shape(regions_sa_pacific )+ tm_polygons(col='Description',alpha=0.2, title='Regions',
                                     palette = c("#332288", "#AA4499", "#44AA99", "#999933")) +tm_legend()+
  tm_layout(legend.title.size = 0.7, legend.text.size = 0.5, legend.width = 0.4, legend.bg.color = "white",legend.frame = "black", legend.position =c('left','bottom')) +
  tm_compass(type = '8star',position = c("right", "top"), size = 2)
```

```{r sa-pacific-num-slip, echo = FALSE, message = FALSE, warning=FALSE}


sa_pacific_sli$subregion <- factor(regions_sa_pacific$Name[unlist(st_intersects(sa_pacific_sli,regions_sa_pacific))])

sa_pac_SLIP <- sa_pacific_sli[sa_pacific_sli$Type.of.datapoint=='Sea Level Indicator',]

table <- sa_pac_SLIP %>% group_by(subregion) %>% summarize(num_SLIP=n(),radiometric=sum(Age.calculation.from=='Radiometric dating'),uniform=sum(Age.calculation.from!='Radiometric dating')) %>% st_drop_geometry()

table$subregion <- factor(table$subregion,levels=c('Ecuador-Peru[N]','Peru[C-S]','Chile[N]','Chile[C]'))

table%>%arrange(subregion)%>% knitr::kable(caption = "South America Pacific coast - Number of SLIP by region",
                           col.names = c('Region name','Number of Sea level Indicators','Radiometric dating','MIS assignment (Uniform)'), escape = FALSE, booktabs=T, digits = 1) %>%add_header_above(c(" "=2, "Origin age calculation" = 2)) %>% kable_styling(font_size = 10,latex_options = c("striped", "scale_down"))


```


```{r south-america-pacific-peaks-processing,eval = TRUE, echo=FALSE, warning=FALSE, error=FALSE, results='hide',dpi=300,cache=TRUE,out.width = "80%",fig.align = "center"}

n_sample <- 10000
file_sa_pacific_peak <- file.path('processing','sea_level_indicators',paste0('sa_pacific_peaks_',n_sample,'.RData'))

if (file.exists(file_sa_pacific_peak)) {
  print('Loading results from pre-processing')
  load(file_sa_pacific_peak)
} else {
  start.time <- Sys.time()
  # Sample SLI (RSL+Age) from total area
  cloud_sa_pacific <- extract_slip_region(sa_pacific_sli, n_samplig=n_sample, sl_stack = sl_stack)
  # Remove values over 200 ka
  cloud_sa_pac_200 <- cloud_sa_pacific[cloud_sa_pacific$AGE<200,]
  # Classify by regions
  cloud_sa_pac_200 <-clasify_by_regions(cloud_sa_pac_200,regions_sa_pacific,sa_pacific_sli)
  
  # Extract Residual values by sub regions
  res_sa_pac_200  <- residuals_by_regions(regions_sa_pacific,cloud_sa_pac_200 ,sa_pacific_sli,per_sampling=0.3)
  
  # Extract residuals by regions in high density age ranges
  res_hdar_sa_pac_200 <- residual_high_density_age_range(res_sa_pac_200)
  
  dir.create('processing')
  dir.create(file.path('processing','sea_level_indicators'))
  save(cloud_sa_pacific, cloud_sa_pac_200,res_sa_pac_200,res_hdar_sa_pac_200, file = file_sa_pacific_peak)
  end.time <- Sys.time()
  time.taken <- end.time - start.time
  time.taken
}
```

```{r south-america-pacific-no-peaks-processing,eval = TRUE, echo=FALSE, warning=FALSE, error=FALSE, results='hide',dpi=300,cache=TRUE,out.width = "80%",fig.align = "center"}

n_sample <- 10000
file_sa_pacific_no_peak <- file.path('processing','sea_level_indicators',paste0('sa_pacific_no_peaks_',n_sample,'.RData'))

if (file.exists(file_sa_pacific_no_peak)) {
  print('Loading results from pre-processing')
  load(file_sa_pacific_no_peak)
} else {
  start.time <- Sys.time()
  # Sample SLI (RSL+Age) from total area without peak sampling method
  cloud_sa_pacific_np <- extract_slip_region(sa_pacific_sli, n_samplig=n_sample)
  # Remove values over 200 ka
  cloud_sa_pac_200_np <- cloud_sa_pacific_np[cloud_sa_pacific_np$AGE<200,]
  # Classify by regions
  cloud_sa_pac_200_np <-clasify_by_regions(cloud_sa_pac_200_np,regions_sa_pacific,sa_pacific_sli)
  
  # Extract Residual values by sub regions
  res_sa_pac_200_np  <- residuals_by_regions(regions_sa_pacific,cloud_sa_pac_200_np ,sa_pacific_sli,per_sampling=0.3)
  
  # Extract residuals by regions in high density age ranges
  res_hdar_sa_pac_200_np <- residual_high_density_age_range(res_sa_pac_200_np)
  
  dir.create('processing')
  dir.create(file.path('processing','sea_level_indicators'))
  save(cloud_sa_pacific_np, cloud_sa_pac_200_np,res_sa_pac_200_np,res_hdar_sa_pac_200_np, file = file_sa_pacific_no_peak)
  end.time <- Sys.time()
  time.taken <- end.time - start.time
  time.taken
}
```


```{r south-america-pacific-GIA-values, eval=TRUE, echo=FALSE, warnings=FALSE, error=FALSE, results='hide',cache=TRUE,out.width = "80%",fig.align = "center"}

#Processing

gia_pacific_file <- file.path('processing','GIA_values','GIA_values_pacific.RData')

if (file.exists(gia_pacific_file)) {
  print('Loading results from pre-processing')
  load(gia_pacific_file)
} else {
  #GIA Values per area
  gia_values <- extract_gia(nc_data,cloud_sa_pac_200,sa_pacific_sli)
  gia_pacific <- bind_rows(gia_values)
  dir.create('processing')
  dir.create(file.path('processing','GIA_values'))
  save(gia_pacific, file = gia_pacific_file)
}

```

### SLIP Point cloud and GIA model values

```{r south-america-pacific-gia-plot, fig.cap= 'South American Pacific coast SLIP and GIA. Lines correspond to GIA models and points (Point cloud) to sea-level indicators resulting from SLIP sampling.',fig.scap= 'South American Pacific coast - GIA models and SLIP point cloud', echo=FALSE, warnings=FALSE, message= FALSE, results='hide', dpi=300, cache=TRUE, out.width = '90%',fig.align = 'center',cache=TRUE}


names_cloud <- c("WALIS_ID","RSL","AGE","region")
regions_names <- c("Ecuador-Peru[N]",'Peru[C-S]','Chile[N]','Chile[C]')
names(cloud_sa_pac_200) <- names_cloud
names(cloud_sa_pac_200_np) <- names_cloud

# Organize 
cloud_sa_pac_200$type <- 'peak_sampling'
cloud_sa_pac_200_np$type <- 'no_peak'

cloud_combined_sa_pac_200 <- bind_rows(cloud_sa_pac_200,cloud_sa_pac_200_np)
cloud_combined_sa_pac_200$region <- factor(cloud_combined_sa_pac_200$region,levels=regions_names)

gia_pacific$region <- factor(gia_pacific$region,levels=regions_names)

# Adjust group colors to match map
group.colors.pacific <- c("Ecuador-Peru[N]" ="#332288", 'Peru[C-S]' = "#AA4499", 'Chile[N]' = "#44AA99", 'Chile[C]' = "#999933")

# Plot results
ggplot()+geom_ribbon(data=gia_pacific,aes(x=time, y=mean, ymin=mean-sd,ymax=mean+sd,group=code,color=region)
                     ,alpha=0.01)+
  geom_point(data=sample_n(cloud_combined_sa_pac_200,20000),
             aes(x=AGE,y=RSL,group=region,color=region),
             alpha=0.01,shape = 21, size = 1, stroke=1)+
  facet_grid(region~type)+
  scale_color_manual(values=group.colors.pacific)+xlim(200,0)+theme_bw()+theme(legend.position='none')+xlab('Age (ka)')+ylab('Relative sea level (m)')+
  theme(panel.spacing = unit(.03, "lines"))

```


Figure \@ref(fig:south-america-pacific-gia-plot) shows the extraction of GIA models values (Lines) and SLIP sampling (Point cloud) previous to the comparison. As for the South American Atlantic coast, GIA models in the Pacific coast have a similar trend with high variability of relative sea-level between 200 and 130 ka and low variability between 130 and 0 ka. However, the Ecuadorian and northern Peruvian regions (Ecuador-Peru[N]) show higher variability in the 130 to 0 ka period. Point clouds of SLIP show differences in the temporal extent of the information between groups. In specific, the Peruvian central and south areas (Peru [C-S]) only have residual values between 130 and 110 ka, while other regions cover longer periods (e.g., Chile[N] covers from 160 ka to 75 ka). Differences in the SLIP cloud points due to the sampling methods are noticeable in all regions. For example, the peak sampling for the northern Chilean area (Chile[N]) shows up to seven clearly defined Point cloud clusters, while the 'no-peak' sampling method results in a more extended Point cloud. Regarding SLIP relative sea-level values, the central Chilean region (Chile[C]) shows for some periods values up to 200 meters while other regions' maximum values range between 60 and 110 m.

### Residual values

The proposed comparison methodology between SLIP and GIA models resulted in residual values for the South American Pacific coast. Figure \@ref(fig:sa-pacific-residual-plot) shows the fitted residual curves in high-density temporal ranges. As for the Atlantic coast, the difference in the sampling methods results in temporal ranges where no comparison is possible. However, for the periods where both sampling techniques have residual values, all regions show similar trends for the *No peak sampling* and *Peak sampling*. On the Ecuadorian and north Peruvian coast (Ecuador-Peru[N]), both sampling methods result in residual values of around 25 and 50 m at 125 ka with an increase up to 80 m at 110 ka. The Peruvian central and south coast (Peru[C-S]) shows a residual level of approximately 50 m at 125 ka. Both the northern Chilean  (Chile[N]) and central (Chile[C]) coast show higher residual values up to 170 m at 140 ka, with a posterior descent to 40 m around 125 ka. Similarly, both regions show residual levels around 50 m at 100 ka and 60 m around 80 ka.

```{r sa-pacific-residual-plot, eval=TRUE, echo=FALSE, warnings=FALSE, message= FALSE, results='hide',dpi=300,cache=TRUE,out.width = "100%",fig.align = "center", fig.cap= 'South American Pacific coast. Residual values by region and sampling method. Solid line correspond to fitted line. Bins represent number of points (point cloud) by age and residual value. ',fig.scap= 'South American Pacific coast - Residual values'}

# Add type of sampling
res_hdar_sa_pac_200$type <- 'peak_sampling'
res_hdar_sa_pac_200_np$type <- 'no_peak'

# Merge into single data frame
res_combined_sa_pac_200 <- bind_rows(res_hdar_sa_pac_200,res_hdar_sa_pac_200_np)
res_combined_sa_pac_200$region <- factor(res_combined_sa_pac_200$region,levels=regions_names)

# Plot results
ggplot(res_combined_sa_pac_200,aes(age,residual,region,group=code,color=region))+geom_bin2d(linetype='blank')+scale_fill_viridis_c(trans='log10',option='magma',alpha=0.4)+geom_smooth(aes(group=code,color=region),level=0.95) + xlim(200,0)+scale_color_manual(values=group.colors.pacific)+facet_grid(region~type)+theme_bw()+theme(panel.spacing = unit(.03, "lines"))+xlab('Age (ka)')+ylab('Residual (m)')+labs(colour='Region')

```

### Evaluation

Figure \@ref(fig:sa-pacific-mean-plot) shows the mean residual values by model parameters (A to E) and by sampling method (F). Comparison between different grouping parameters (A to E) using the same sampling methods shows a similar distribution of mean values except for the Propagation parameter, where the difference is notable. As for the Atlantic coast, residual values tend to be higher for residuals using 'no-peak' sampling for all the model parameters (See Figure \@ref(fig:sa-atlantic-mean-plot))
That is confirmed by a Kruskal test with a P-value lower than 0.05 testing the $H_{0}$ hypothesis that the mean values between sampling techniques are equal.

```{r sa-pacific-mean-plot, eval=TRUE, echo=FALSE, warnings=FALSE, message= FALSE, results='hide',dpi=300,cache=TRUE, out.width='100%',fig.height = 8,fig.width=9,fig.align = "center",fig.cap= 'South American Pacific coast mean residual values by model parameters and sampling method.',fig.scap= 'South American Pacific coast - Mean residual values by grouping parameters'}

mean_models <- res_combined_sa_pac_200%>%group_by(type,region,propagation,ice,lm,um,lt)%>%summarise(mean = mean(residual),sd = std(residual),n =n())

mean_models$region <- factor(mean_models$region,levels=regions_names)

fig_1 <- ggplot(mean_models, aes(factor(propagation),mean,fill=factor(propagation)))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour = factor(propagation)),alpha=0.5,width = 0.2)+labs(fill = "Propagation",colour='Propagation')+xlab("Parameter")+ylab("Mean (Residual) ")+facet_wrap(~type,ncol=2)+theme_bw()

fig_2 <-ggplot(mean_models, aes(factor(ice),mean,fill=factor(ice)))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour = factor(ice)),alpha=0.5,width = 0.2)+labs(fill = "Ice\nmodel",colour='Ice\nmodel')+xlab("Parameter")+ylab("Mean (Residual) ")+facet_wrap(~type,ncol=2)+theme_bw()

fig_3 <-ggplot(mean_models, aes(factor(lm),mean,fill=factor(lm)))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour = factor(lm)),alpha=0.5,width = 0.2)+labs(fill = "Lower\nmantle\nviscosity",colour='Lower\nmantle\nviscosity')+xlab("Parameter")+ylab("Mean (Residual) ")+facet_wrap(~type,ncol=2)+theme_bw()

fig_4 <-ggplot(mean_models, aes(factor(um),mean,fill=factor(um)))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour = factor(um)),alpha=0.5,width = 0.2)+labs(fill = "Upper\nmantle\nviscosity",colour='Upper\nmantle\nviscosity')+xlab("Parameter")+ylab("Mean (Residual) ")+facet_wrap(~type,ncol=2)+theme_bw()

fig_5 <-ggplot(mean_models, aes(factor(lt),mean,fill=factor(lt)))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour = factor(lt)),alpha=0.5,width = 0.2)+labs(fill = "Lithospheric\nthickness",colour='Lithospheric\nthickness')+xlab("Parameter")+ylab("Mean (Residual) ")+facet_wrap(~type,ncol=2)+theme_bw()

fig_6 <- ggplot(mean_models, aes(factor(type),mean,fill=factor(type)))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour = factor(type)),alpha=0.5,width = 0.2)+labs(fill = "Sampling\n type",colour='Sampling\n type')+xlab("Parameter")+ylab("Mean (Residual) ")+theme_bw()

figure <- ggarrange(fig_1, fig_2, fig_3,fig_4,fig_5,fig_6,
                    labels = c("A", "B", "C","D","E","F"),
                    ncol = 2, nrow = 3)
figure

```

Additional Kruskal tests were applied to identify differences in mean residual values resulting from different GIA model parameters, their geographic area, and specific GIA model configuration (See Table \@ref(tab:sa-atlantic-kruskal)). The $H_{0}$ hypothesis for all tests is that the mean value of all parameters is the same. $H_{1}$ for all cases is that mean values are different. Table \@ref(tab:sa-pacific-kruskal) shows that for all cases the null hypothesis  $H_{0}$ is rejected using a P-value of 0.05 (P-values lower than 0.05 in **bold**). 

```{r sa-pacific-kruskal, echo = FALSE, message = FALSE, warning=FALSE}

# Add model parameter to residuals

# Peak sampling
res_hdar_sa_pac_200$model <- as.factor(paste(res_hdar_sa_pac_200$propagation,
                                              res_hdar_sa_pac_200$ice,
                                              res_hdar_sa_pac_200$lm,
                                              res_hdar_sa_pac_200$um,
                                              res_hdar_sa_pac_200$lt,
                                              sep='-')
                                       )
# Normal sampling (np)

res_hdar_sa_pac_200_np$model <- as.factor(paste(res_hdar_sa_pac_200_np$propagation,
                                              res_hdar_sa_pac_200_np$ice,
                                              res_hdar_sa_pac_200_np$lm,
                                              res_hdar_sa_pac_200_np$um,
                                              res_hdar_sa_pac_200_np$lt,
                                              sep='-')
                                       )

# Kruskal test for peak sampling residuals

file_sa_pacific_kruskal<- file.path('processing','kruskal_test','sa_pacific_kruskal.RData')

if (file.exists(file_sa_pacific_kruskal)){
  load(file_sa_pacific_kruskal)
}else{

  kt_sa_pac <- lapply(colnames(res_hdar_sa_pac_200)[c(3,5,6,7,8,9,11)], function(x) kruskal.test(res_hdar_sa_pac_200$residual ~ as.factor(unlist(res_hdar_sa_pac_200[x])), data = res_hdar_sa_pac_200))
  
  # Kruskal test for residuals (no peak sampling)
  
  kt_sa_pac_np <- lapply(colnames(res_hdar_sa_pac_200_np)[c(3,5,6,7,8,9,11)], function(x) kruskal.test(res_hdar_sa_pac_200_np$residual ~ as.factor(unlist(res_hdar_sa_pac_200_np[x])), data = res_hdar_sa_pac_200_np))
  
  dir.create(file.path('processing','kruskal_test'))
  save(kt_sa_pac,kt_sa_pac_np, file = file_sa_pacific_kruskal)
}

param_names <- c('Region','Propagation','Ice','Lower mantle viscosity','Upper mantle viscosity','Lithospheric thickness', 'Model')

sa_pac_kt <- data.frame(parameter=param_names,df = unlist(lapply(kt_sa_pac_np, '[[', 2)),chi_np=unlist(lapply(kt_sa_pac_np, '[[', 1)),p_value_np=unlist(lapply(kt_sa_pac_np, '[[', 3)),chi_ps=unlist(lapply(kt_sa_pac, '[[', 1)),p_value_ps=unlist(lapply(kt_sa_pac, '[[', 3)))

#Highlight significant P-value

pv_np <- sa_pac_kt$p_value_np<0.05
h_pv_np <- pv_np
h_pv_np<- replace(h_pv_np,pv_np,'#e6ffe6')
h_pv_np <- replace(h_pv_np,!pv_np,'white')

pv_ps<- sa_pac_kt$p_value_ps<0.05
h_pv_ps <- pv_ps
h_pv_ps <- replace(h_pv_ps,h_pv_ps,'#e6ffe6')
h_pv_ps <- replace(h_pv_ps,!pv_ps,'white')


sa_pac_kt$p_value_np <- scientific(sa_pac_kt$p_value_np,digits = 3) 
sa_pac_kt$p_value_ps <- scientific(sa_pac_kt$p_value_ps,digits = 3) 

sa_pac_kt%>% knitr::kable(caption = "South America Pacific coast - Kruskal test",
                           col.names = c('Parameter','Degrees of freedom','$\\tilde{\\chi}^2$','P-value','$\\tilde{\\chi}^2$','P-value'), escape = FALSE, booktabs=T, digits = 1) %>%add_header_above(c(" "=2, "No peak sampling" = 2, "Peak sampling" = 2)) %>% kable_styling(font_size = 10,latex_options = c("striped", "scale_down"))%>% column_spec(4, bold = pv_np)%>%column_spec(6, bold = pv_ps)

```


A Pair-Wise Wilcox test was performed to identify the parameters, regions, or specific model that produces significantly different residual results. Table \@ref(tab:sa-pacific-wilcox-table) shows the total of possible combinations (Pairs) for each grouping parameter and the number of pairs with statistically significant differences (P-value < 0.05) for their mean values. As the main result, all combinations of regions have statistically significant differences for both sampling techniques. Similarly, all model parameters (except Lower mantle viscosity) have a high proportion of pairs (more than 50%) with significant differences in their mean values. Lastly, the pair-wise tests show that for both the *No-peak* and *Peak sampling*,  there is an important proportion of significantly different pairs of residual values by model (Around 30 to 52%). That suggests that some models result in consistently different residual values. 

```{r sa-pacific-wilcox-processing, echo = FALSE, message = FALSE, warning=FALSE, cache=TRUE}

file_sa_pacific_wilcox<- file.path('processing','wilcox_test','sa_pacific_wilcox.RData')

if (file.exists(file_sa_pacific_wilcox)){
  load(file_sa_pacific_wilcox)
}else{
  wilcox_pac_peak <- lapply(colnames(res_hdar_sa_pac_200)[c(3,5,6,7,8,9,11)], function(x) pairwise.wilcox.test(res_hdar_sa_pac_200$residual, as.factor(unlist(res_hdar_sa_pac_200[x])),p.adjust.method = "bonferroni"))
  
  wilcox_pac_np <- lapply(colnames(res_hdar_sa_pac_200_np)[c(3,5,6,7,8,9,11)], function(x) pairwise.wilcox.test(res_hdar_sa_pac_200_np$residual, as.factor(unlist(res_hdar_sa_pac_200_np[x])),p.adjust.method = "bonferroni"))

  dir.create(file.path('processing','wilcox_test'))
  save(wilcox_pac_peak,wilcox_pac_np, file = file_sa_pacific_wilcox)

}

```


```{r sa-pacific-wilcox-table, echo = FALSE, message = FALSE, warning=FALSE,cache=TRUE}

sa_pac_pairwise_wilcox <- data.frame(parameter = param_names,
                                     pairs = unlist(lapply(c(3,5,6,7,8,9,11),function(x) choose(nrow(unique(res_hdar_sa_pac_200[x])),2))),
                                     sig.dif.np = unlist(lapply(1:7, function(x) sum(wilcox_pac_peak[[x]][['p.value']]<0.05,na.rm=TRUE))),
                                     sig.dif.peaks = unlist(lapply(1:7, function(x) sum(wilcox_pac_np[[x]][['p.value']]<0.05,na.rm=TRUE)))
                                     )

sa_pac_pairwise_wilcox%>% knitr::kable(caption = "South America Pacific coast - Pairwise Wilcox test",
                           col.names = c('Grouping parameter','Number of pairs','Significant different pairs','Significant different pairs'), escape = FALSE, booktabs=T, digits = 1) %>% add_header_above(c(" "=2, "No peak sampling" = 1, "Peak sampling" = 1)) %>% kable_styling(font_size = 10,latex_options = c("striped", "scale_down"))

```


```{r correlation-pa-value, eval=FALSE, message=FALSE,warning=FALSE,echo=FALSE}

model_wilcox <- wilcox_pac_np[[7]]$p.value
model_wilcox <- melt(model_wilcox) %>%drop_na()
m_w_transpose <- data.frame(Var1=model_wilcox$Var2,Var2=model_wilcox$Var1,value=model_wilcox$value)
m_w_diagonal <- data.frame(Var1=unique(res_hdar_sa_pac_200$model),Var2=unique(res_hdar_sa_pac_200$model),value=1)
mw_p_value <- rbind(model_wilcox,m_w_transpose,m_w_diagonal)
df <- as.data.frame(reshape::cast(mw_p_value,Var1~Var2,fill=1))
df <- df[,sort(names(df))]

mw_p_value %>% group_by(Var1)%>%summarise(x = sum(value <= 0.05))
view(res_hdar_sa_pac_200%>%group_by(model)%>%summarise(mean=mean(residual)))

```

As suggested by the Kruskal tests, residual mean values for different regions are different. Figure \@ref(fig:south-america-pacific-mean-region) shows the residual mean values grouped by region and sampling technique. As for the other grouping parameters, mean residual values from 'Peak-sampling' are in all cases lower than the ones resulting from 'No-peak' sampling. For both sampling methods, the Ecuadorian and northern Peruvian coast (Ecuador-Peru[N]), the central Peruvian (Peru[C-S]), and the north Chilean coast (Chile[N]) coincide in their relative position. That is with Chile[N] as the one with the highest mean residual values, followed by the Ecuador-Peru[N] and the Peru[C-S] area. However, the central Chilean region shows changes. This region varies from being the one with the second-highest mean values (around 60m) for the *No-peak sampling* to being the one with lowest mean values for the *peak sampling* technique.

```{r south-america-pacific-mean-region, eval=TRUE, echo=FALSE, warnings=FALSE, message= FALSE, results='hide',dpi=300,cache=TRUE,out.width = "90%",fig.height = 8,fig.width=10, fig.align = "center", fig.cap= 'South American Pacific coast mean residual values by region.',fig.scap= 'South American Pacific coast - Mean residual values by region'}

mean_models <- res_combined_sa_pac_200%>%group_by(region,propagation,ice,lm,um,lt,type)%>%summarise(mean = mean(residual),sd = std(residual),n =n())

ggplot(mean_models, aes(factor(region),mean,colour=region))+geom_boxplot(width=0.4,alpha=0.5,outlier.shape = NA)+geom_jitter(aes(colour=factor(region)),alpha=0.1,width = 0.2)+scale_color_manual(values=group.colors.pacific)+facet_wrap(vars(type),ncol=2)+labs(colour='Region')+xlab("Region")+ylab("Mean (Residual)")+theme_bw()

```

